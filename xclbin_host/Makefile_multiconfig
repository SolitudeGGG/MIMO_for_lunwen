# MIMO MIMO Multi-Configuration Makefile
# Supports building different MIMO configurations with optimized ap_fixed types

############################## Help Section ##############################
.PHONY: help

help::
	$(ECHO) "Makefile Usage:"
	$(ECHO) "  make build MIMO_CONFIG=<config>"
	$(ECHO) "      Build a specific MIMO configuration."
	$(ECHO) "      Available configs: 4x4_16QAM, 8x8_4QAM, 8x8_16QAM, 8x8_64QAM, 16x16_16QAM, 16x16_64QAM"
	$(ECHO) ""
	$(ECHO) "  make build-all"
	$(ECHO) "      Build all MIMO configurations."
	$(ECHO) ""
	$(ECHO) "  make clean"
	$(ECHO) "      Remove all generated files."
	$(ECHO) ""

# ####################### Setting file directory #######################################
MK_PATH := $(abspath $(lastword $(MAKEFILE_LIST)))
CUR_DIR := $(patsubst %/,%,$(dir $(MK_PATH)))
SRCDIR := $(CUR_DIR)/../
HEADERS_DIR := $(CUR_DIR)/../headers
BUILD_BASE_DIR := $(CUR_DIR)/build

# ####################### MIMO Configuration Selection #################################
# Default configuration if not specified
MIMO_CONFIG ?= 8x8_16QAM

# Set configuration-specific directories
CONFIG_HEADER_DIR := $(HEADERS_DIR)/mimo_$(MIMO_CONFIG)
BUILD_DIR := $(BUILD_BASE_DIR)/$(MIMO_CONFIG)
BUILD_REPORT_DIR := $(BUILD_DIR)/reports/build
TEMP_DIR := $(BUILD_DIR)/temp
TEMP_REPORT_DIR := $(BUILD_DIR)/reports/temp
LOG_DIR := $(BUILD_DIR)/logs

# ####################### Setting objects and source files #############################
BUILD_XCLBIN := $(BUILD_DIR)/kernel_$(MIMO_CONFIG).xclbin
BUILD_XOBJECT := $(TEMP_DIR)/krnl_MHGD_$(MIMO_CONFIG).xo
BUILD_SOURCE += $(SRCDIR)/MHGD_accel_hw.cpp
BUILD_SOURCE += $(SRCDIR)/MHGD_accel_hw.h
# Use configuration-specific header instead of MyComplex_1.h
# BUILD_SOURCE += $(SRCDIR)/MyComplex_1.h

# ####################### Setting compile environment ##################################
VPP ?= ${XILINX_VITIS}/bin/v++
TARGET ?= hw	# can be configured with sw_emu or hw_emu
PLATFORM ?= xilinx_u50_gen3x16_xdma_5_202210_1
KERNEL_NAME = MHGD_detect_accel_hw
CLOCK_FREQ_MHZ = 100000000

# ####################### Setting compile and link flags ##################################
VPP_FLAGS += -I $(SRCDIR)
# Add configuration-specific header directory with higher priority
VPP_FLAGS += -I $(CONFIG_HEADER_DIR)
VPP_FLAGS += -t $(TARGET) --config $(CUR_DIR)/MHGD_compile.cfg 
VPP_FLAGS += --platform $(PLATFORM)
VPP_FLAGS += --hls.clock $(CLOCK_FREQ_MHZ):$(KERNEL_NAME)
VPP_FLAGS += --hls.pre_tcl $(SRCDIR)/hls_config.tcl

############################## Setting Makefile Targets ##############################
build: $(BUILD_XCLBIN)
	@echo "GENERATE $(BUILD_XCLBIN) Done!"

# ################ Setting Rules for Binary Containers (Building Kernels) ###############
#  ###### Linking Kernel ######
$(BUILD_XCLBIN): $(BUILD_XOBJECT)
	@echo "==================================================================="
	@echo "Linking Kernel for MIMO Configuration: $(MIMO_CONFIG)"
	@echo "==================================================================="
	@echo "$(VPP) -l $(VPP_FLAGS) $(BUILD_XOBJECT) -o $@"
	mkdir -p $(BUILD_DIR)
	$(VPP) -l $(VPP_FLAGS) $(BUILD_XOBJECT) --temp_dir $(TEMP_DIR) --report_dir $(BUILD_REPORT_DIR)/$(KERNEL_NAME) -o $@

#  ###### Compile Kernel ######
$(BUILD_XOBJECT): $(BUILD_SOURCE)
	@echo "==================================================================="
	@echo "Compiling Kernel for MIMO Configuration: $(MIMO_CONFIG)"
	@echo "Using header directory: $(CONFIG_HEADER_DIR)"
	@echo "==================================================================="
	@echo "$(VPP) -c $(VPP_FLAGS) $(BUILD_SOURCE) -k $(KERNEL_NAME) -o $@"
	mkdir -p $(TEMP_DIR)
	$(VPP) -c $(VPP_FLAGS) $(BUILD_SOURCE) -k $(KERNEL_NAME) --temp_dir $(TEMP_DIR) --report_dir $(TEMP_REPORT_DIR) -o $@

# ####################### Build All Configurations ####################################
.PHONY: build-all
build-all:
	@echo "Building all MIMO configurations..."
	$(MAKE) build MIMO_CONFIG=4x4_16QAM
	$(MAKE) build MIMO_CONFIG=8x8_4QAM
	$(MAKE) build MIMO_CONFIG=8x8_16QAM
	$(MAKE) build MIMO_CONFIG=8x8_64QAM
	$(MAKE) build MIMO_CONFIG=16x16_16QAM
	$(MAKE) build MIMO_CONFIG=16x16_64QAM
	@echo "All configurations built successfully!"

# ####################### Clean Target ################################################
clean:
	rm -rf *.json .run .Xil .ipcache *.jou *.log $(BUILD_BASE_DIR)
	@echo "Cleaned all build artifacts."

.PHONY: list-configs
list-configs:
	@echo "Available MIMO configurations:"
	@echo "  - 4x4_16QAM    (4x4 MIMO with 16QAM modulation)"
	@echo "  - 8x8_4QAM     (8x8 MIMO with 4QAM modulation)"
	@echo "  - 8x8_16QAM    (8x8 MIMO with 16QAM modulation)"
	@echo "  - 8x8_64QAM    (8x8 MIMO with 64QAM modulation)"
	@echo "  - 16x16_16QAM  (16x16 MIMO with 16QAM modulation)"
	@echo "  - 16x16_64QAM  (16x16 MIMO with 64QAM modulation)"
