# MIMO HLS 位宽优化系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    MIMO HLS 位宽优化自动化系统                            │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 步骤1: 数据生成                                                           │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │  generate_mimo_data.py                                              │ │
│ │  ┌──────────┐  ┌──────────┐  ┌──────────┐                          │ │
│ │  │ 4-QAM    │  │ 16-QAM   │  │ 64-QAM   │                          │ │
│ │  └──────────┘  └──────────┘  └──────────┘                          │ │
│ │       │              │              │                                │ │
│ │       └──────────────┴──────────────┘                                │ │
│ │                      │                                                │ │
│ │           ┌──────────▼──────────┐                                    │ │
│ │           │  SNR: 5-25 dB       │                                    │ │
│ │           │  步长: 5 dB         │                                    │ │
│ │           └──────────┬──────────┘                                    │ │
│ │                      │                                                │ │
│ │           ┌──────────▼──────────┐                                    │ │
│ │           │  生成测试数据:       │                                    │ │
│ │           │  • H矩阵            │                                    │ │
│ │           │  • y向量            │                                    │ │
│ │           │  • 参考比特流        │                                    │ │
│ │           │  • 高斯噪声         │                                    │ │
│ │           └─────────────────────┘                                    │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 步骤2: 子函数分析（可选）                                                  │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │  subfunction_analyzer.py                                            │ │
│ │  ┌───────────────────────────────────────────────────────────────┐ │ │
│ │  │ 解析 MHGD_accel_hw.cpp                                         │ │ │
│ │  │  • 识别77个函数                                                 │ │ │
│ │  │  • 提取局部变量                                                 │ │ │
│ │  │  • 智能位宽建议                                                 │ │ │
│ │  └───────────────────────────────────────────────────────────────┘ │ │
│ │                              │                                       │ │
│ │                    ┌─────────▼─────────┐                            │ │
│ │                    │ 输出:              │                            │ │
│ │                    │ • 分析报告JSON     │                            │ │
│ │                    │ • 扩展模板jinja2   │                            │ │
│ │                    └───────────────────┘                            │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 步骤3: 位宽优化                                                           │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │  bitwidth_optimization.py / batch_optimization.py                   │ │
│ │  ┌───────────────────────────────────────────────────────────────┐ │ │
│ │  │ 1. 解析MyComplex_1.h → 45个变量                                │ │ │
│ │  └───────────────────────────────────────────────────────────────┘ │ │
│ │                              ▼                                       │ │
│ │  ┌───────────────────────────────────────────────────────────────┐ │ │
│ │  │ 2. 运行64位全精度基准测试 → 获取基准BER                          │ │ │
│ │  └───────────────────────────────────────────────────────────────┘ │ │
│ │                              ▼                                       │ │
│ │  ┌───────────────────────────────────────────────────────────────┐ │ │
│ │  │ 3. 对每个变量:                                                  │ │ │
│ │  │    • 从当前位宽开始                                             │ │ │
│ │  │    • 逐步减小位宽（步长=2）                                     │ │ │
│ │  │    • 编译并测试                                                 │ │ │
│ │  │    • 计算BER                                                   │ │ │
│ │  │    • 如果BER超阈值，停止                                        │ │ │
│ │  └───────────────────────────────────────────────────────────────┘ │ │
│ │                              ▼                                       │ │
│ │  ┌───────────────────────────────────────────────────────────────┐ │ │
│ │  │ 4. 输出:                                                        │ │ │
│ │  │    • bitwidth_config_*.json (配置+BER)                         │ │ │
│ │  │    • MyComplex_optimized_*.h (优化头文件)                       │ │ │
│ │  └───────────────────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 主控脚本                                                                  │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │  master_optimization.py                                             │ │
│ │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐          │ │
│ │  │ 依赖检查       │→ │ 数据生成       │→ │ 子函数分析     │          │ │
│ │  └───────────────┘  └───────────────┘  └───────────────┘          │ │
│ │          │                                      │                   │ │
│ │          └──────────────────┬───────────────────┘                   │ │
│ │                             ▼                                        │ │
│ │                  ┌──────────────────────┐                           │ │
│ │                  │   位宽优化执行        │                           │ │
│ │                  └──────────┬───────────┘                           │ │
│ │                             ▼                                        │ │
│ │                  ┌──────────────────────┐                           │ │
│ │                  │   生成总结报告        │                           │ │
│ │                  └──────────────────────┘                           │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 配置组合（批量优化）                                                        │
│                                                                           │
│  天线配置: 8x8                                                            │
│  ┌──────────┬──────────┬──────────┐                                     │
│  │ 4-QAM    │ 16-QAM   │ 64-QAM   │                                     │
│  ├──────────┼──────────┼──────────┤                                     │
│  │ SNR=5dB  │ SNR=5dB  │ SNR=5dB  │                                     │
│  │ SNR=10dB │ SNR=10dB │ SNR=10dB │                                     │
│  │ SNR=15dB │ SNR=15dB │ SNR=15dB │                                     │
│  │ SNR=20dB │ SNR=20dB │ SNR=20dB │                                     │
│  │ SNR=25dB │ SNR=25dB │ SNR=25dB │                                     │
│  └──────────┴──────────┴──────────┘                                     │
│                                                                           │
│  总计: 15个配置组合                                                        │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 输出文件                                                                  │
│                                                                           │
│  mimo_data/                       optimized_headers/                    │
│  ├── H_*.txt                      ├── bitwidth_config_*.json            │
│  ├── y_*.txt                      └── MyComplex_optimized_*.h           │
│  ├── bits_*.txt                                                         │
│  └── gaussian_noise/              subfunction_analysis_report.json      │
│                                   sensitivity_types_extended.hpp.jinja2 │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 优化算法核心逻辑                                                          │
│                                                                           │
│  对于每个变量 var:                                                        │
│    current_W = var.init_W                                                │
│    min_W = var.init_I + 2                                                │
│                                                                           │
│    for test_W in range(current_W, min_W, -2):  // 步长=2               │
│      生成测试配置(var, test_W)                                            │
│      编译 → 运行 → 计算BER                                                │
│                                                                           │
│      if |BER_new - BER_baseline| <= threshold:                           │
│        继续减小位宽                                                       │
│      else:                                                                │
│        停止，使用上一个位宽                                               │
│        break                                                              │
│                                                                           │
│  优化策略:                                                                │
│  • sequential: 按定义顺序                                                │
│  • high_to_low: 优先优化高位宽变量                                        │
│  • low_to_high: 优先优化低位宽变量                                        │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ 关键指标                                                                  │
│                                                                           │
│  • 识别变量: 45个                                                         │
│  • 识别函数: 77个                                                         │
│  • 配置组合: 15个                                                         │
│  • 默认BER阈值: 1e-4                                                      │
│  • 默认位宽步长: 2                                                        │
│  • 预期资源节省: 20-40% (寄存器), 15-30% (LUT)                           │
└─────────────────────────────────────────────────────────────────────────┘
```
